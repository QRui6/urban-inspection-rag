# 城市体检RAG系统 - Nginx反向代理配置（修复后）
user  nginx;                  # Nginx运行用户（容器内默认）
worker_processes  auto;       # 工作进程数（自动适配CPU）

error_log  /var/log/nginx/error.log notice;  # 错误日志
pid        /var/run/nginx.pid;               # 进程PID文件

# 必需模块：处理网络连接（Nginx启动必填）
events {
    worker_connections  1024;  # 每个进程最大连接数
}

# 核心模块：所有HTTP/反向代理配置必须放在 http 内部
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;
    sendfile        on;
    keepalive_timeout  65;

    # 修复后的 upstream
    upstream rag_backend {
        server rag-system:5000 max_fails=3;
        keepalive 32;
    }

    upstream chroma_backend {
        server chromadb:8000 max_fails=3;
        keepalive 32;
    }

    # server 块配置不变（之前的反向代理、CORS 等保留）
    server {
        listen 80;
        server_name localhost;
                # 健康检查端点
        location /api/health {
            proxy_pass http://rag_backend/api/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

        # 主API接口（优先级：最长前缀匹配，会被 /api/upload 覆盖）
        location /api/ {
            proxy_pass http://rag_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

            # 大文件上传支持
            client_max_body_size 100M;
            proxy_buffering off;

            # 3. 优化：CORS配置（修复冲突，避免浏览器报错）
            add_header Access-Control-Allow-Origin *;  # 允许所有来源（生产环境指定具体域名）
            add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS;
            add_header Access-Control-Allow-Headers Content-Type,Authorization,session-id;
            # 注意：Access-Control-Allow-Credentials true 与 * 冲突，注释掉（否则浏览器报错）
            # add_header Access-Control-Allow-Credentials true;

            # 处理预检请求（OPTIONS）
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin *;
                add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS;
                add_header Access-Control-Allow-Headers Content-Type,Authorization,session-id;
                add_header Access-Control-Max-Age 1728000;  # 预检请求缓存 24 小时
                add_header Content-Type text/plain;
                add_header Content-Length 0;
                return 204;
            }
        }

        # 专用文件上传接口（最长前缀匹配，优先于 /api/）
        location /api/upload {
            proxy_pass http://rag_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_connect_timeout 120s;  # 上传超时延长到 2 分钟
            proxy_send_timeout 120s;
            proxy_read_timeout 120s;

            # 增强大文件支持
            client_max_body_size 200M;  # 支持最大 200M 上传
            proxy_request_buffering off;  # 禁用请求缓冲（大文件必备）
            proxy_buffering off;
        }

        # 默认请求处理（所有未匹配的请求转发到后端）
        location / {
            proxy_pass http://rag_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # 错误页面配置
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;  # Nginx默认静态文件目录
            internal;  # 仅内部访问，不允许外部直接请求
        }
    }

    # HTTPS配置（需要证书时启用，本地测试先注释）
    # server {
    #     listen 443 ssl;
    #     server_name your-domain.com;  # 替换为你的域名
    #
    #     ssl_certificate /etc/nginx/ssl/cert.pem;    # 证书路径（需挂载到容器）
    #     ssl_certificate_key /etc/nginx/ssl/key.pem;  # 私钥路径
    #
    #     # SSL优化参数（可选）
    #     ssl_protocols TLSv1.2 TLSv1.3;
    #     ssl_prefer_server_ciphers on;
    #     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    #
    #     location / {
    #         proxy_pass http://rag_backend;
    #         proxy_set_header Host $host;
    #         proxy_set_header X-Forwarded-Proto $scheme;  # 传递HTTPS协议标识
    #         proxy_set_header X-Real-IP $remote_addr;
    #     }
    # }
}