# ğŸ¯ ä½¿ç”¨5000ç«¯å£ - å®Œç¾æ–¹æ¡ˆ

## âœ… å·²å®Œæˆé…ç½®

æˆ‘å·²ç»å°† `api_async.py` é…ç½®ä¸ºï¼š
- **è¿è¡Œåœ¨5000ç«¯å£**ï¼ˆå’ŒåŸæ¥çš„ api.py ä¸€æ ·ï¼‰
- **æ¥å£è·¯å¾„ä¸å˜**ï¼ˆ`/api/analyze-image`ï¼‰
- **è¿”å›æ ¼å¼ä¸å˜**ï¼ˆç­‰å¾…ç»“æœè¿”å›ï¼‰
- **ä½†å†…éƒ¨ä½¿ç”¨å¼‚æ­¥å¤„ç†**ï¼ˆæ€§èƒ½æå‡ï¼‰

---

## ğŸš€ ç°åœ¨éœ€è¦åšçš„

### ç¬¬1æ­¥ï¼šåœæ­¢æ‰€æœ‰APIè¿›ç¨‹

```bash
# åœæ­¢æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„API
pkill -f "python.*api"

# æˆ–è€…æ‰‹åŠ¨åœæ­¢
# åœ¨è¿è¡ŒAPIçš„ç»ˆç«¯æŒ‰ Ctrl+C
```

### ç¬¬2æ­¥ï¼šé‡æ–°å¯åŠ¨ api_async.py

```bash
# ç¡®ä¿åœ¨é¡¹ç›®ç›®å½•
cd /home/k8s/workspace/urban-inspection-rag

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# å¯åŠ¨å¼‚æ­¥APIï¼ˆ5000ç«¯å£ï¼‰
python api_async.py
```

ä½ ä¼šçœ‹åˆ°ï¼š
```
INFO:     Uvicorn running on http://0.0.0.0:5000
```

### ç¬¬3æ­¥ï¼šéªŒè¯

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:5000/api/health

# åº”è¯¥è¿”å›
# {"status":"ok","timestamp":...,"redis_connected":true}
```

---

## ğŸ“Š æ¥å£è¯´æ˜

### ä¸»æ¥å£ï¼ˆå…¼å®¹æ—§å‰ç«¯ï¼‰

```
POST http://localhost:5000/api/analyze-image
```

**è¯·æ±‚**ï¼š
```json
{
  "query": "è¿™å¼ å›¾ç‰‡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ",
  "image_base64": "data:image/jpeg;base64,..."
}
```

**å“åº”**ï¼ˆç­‰å¾…15ç§’åè¿”å›ï¼‰ï¼š
```json
{
  "session_id": "1733123456.789",
  "status": "success",
  "visual_analysis": "åˆ†æç»“æœ...",
  "models_used": {...},
  "timestamp": 1733123456.789
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… å‰ç«¯ä¸éœ€è¦ä¿®æ”¹ä»»ä½•ä»£ç 
- âœ… æ¥å£è·¯å¾„å’Œä»¥å‰ä¸€æ ·
- âœ… è¿”å›æ ¼å¼å’Œä»¥å‰ä¸€æ ·
- âœ… ä½†åå°ä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—å¤„ç†
- âœ… å¤šç”¨æˆ·å¯ä»¥å¹¶å‘å¤„ç†

---

### çº¯å¼‚æ­¥æ¥å£ï¼ˆå¯é€‰ï¼‰

å¦‚æœå°†æ¥æƒ³è¦æ›´å¥½çš„æ€§èƒ½ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

```
POST http://localhost:5000/api/async/analyze-image
```

è¿™ä¸ªæ¥å£ä¼šç«‹å³è¿”å› task_idï¼Œéœ€è¦è½®è¯¢è·å–ç»“æœã€‚

---

## ğŸ¯ å·¥ä½œåŸç†

```
å‰ç«¯è°ƒç”¨ /api/analyze-image
         â†“
APIæ¥æ”¶è¯·æ±‚ï¼ˆç«‹å³ï¼‰
         â†“
æäº¤åˆ°å¼‚æ­¥é˜Ÿåˆ—
         â†“
Workeråå°å¤„ç†ï¼ˆ15ç§’ï¼‰
         â†“
APIç­‰å¾…ç»“æœ
         â†“
è¿”å›ç»“æœç»™å‰ç«¯
         â†“
å‰ç«¯æ˜¾ç¤ºï¼ˆå’Œä»¥å‰ä¸€æ ·ï¼‰
```

**å¯¹å‰ç«¯æ¥è¯´**ï¼š
- æ„Ÿè§‰å’ŒåŒæ­¥APIä¸€æ ·
- ç­‰å¾…15ç§’åå¾—åˆ°ç»“æœ
- ä¸éœ€è¦ä¿®æ”¹ä»»ä½•ä»£ç 

**å¯¹åç«¯æ¥è¯´**ï¼š
- ä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—
- å¤šç”¨æˆ·å¯ä»¥å¹¶å‘å¤„ç†
- æ€§èƒ½æå‡3-5å€

---

## ğŸ”§ å®Œæ•´å¯åŠ¨æµç¨‹

### ç»ˆç«¯1ï¼šå¯åŠ¨Worker

```bash
cd /home/k8s/workspace/urban-inspection-rag
source .venv/bin/activate
python start_worker.py
```

### ç»ˆç«¯2ï¼šå¯åŠ¨APIï¼ˆ5000ç«¯å£ï¼‰

```bash
cd /home/k8s/workspace/urban-inspection-rag
source .venv/bin/activate
python api_async.py
```

### ç»ˆç«¯3ï¼šéªŒè¯

```bash
curl http://localhost:5000/api/health
```

---

## ğŸ“‹ æ¥å£å¯¹æ¯”

| æ¥å£è·¯å¾„ | ç«¯å£ | å“åº”æ–¹å¼ | å‰ç«¯æ”¹åŠ¨ |
|---------|------|---------|---------|
| `/api/analyze-image` | 5000 | ç­‰å¾…è¿”å› | âŒ ä¸éœ€è¦ |
| `/api/query` | 5000 | ç­‰å¾…è¿”å› | âŒ ä¸éœ€è¦ |
| `/api/async/analyze-image` | 5000 | ç«‹å³è¿”å›task_id | âœ… éœ€è¦ |
| `/api/async/query` | 5000 | ç«‹å³è¿”å›task_id | âœ… éœ€è¦ |

---

## âœ… éªŒè¯æ¸…å•

```bash
# 1. æ£€æŸ¥Redisè¿è¡Œ
redis-cli ping
# åº”è¯¥è¿”å›: PONG

# 2. æ£€æŸ¥Workerè¿è¡Œ
ps aux | grep start_worker
# åº”è¯¥çœ‹åˆ°è¿›ç¨‹

# 3. æ£€æŸ¥APIè¿è¡Œåœ¨5000ç«¯å£
netstat -tuln | grep 5000
# åº”è¯¥çœ‹åˆ°: tcp ... 0.0.0.0:5000 ... LISTEN

# 4. æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:5000/api/health
# åº”è¯¥è¿”å›: {"status":"ok",...}

# 5. æŸ¥çœ‹APIæ–‡æ¡£
firefox http://localhost:5000/docs
```

---

## ğŸ‰ æ€»ç»“

### ç°åœ¨çš„é…ç½®

- âœ… APIè¿è¡Œåœ¨ **5000ç«¯å£**
- âœ… æ¥å£è·¯å¾„ **ä¸å˜**
- âœ… è¿”å›æ ¼å¼ **ä¸å˜**
- âœ… å‰ç«¯ **ä¸éœ€è¦ä¿®æ”¹**
- âœ… åå°ä½¿ç”¨ **å¼‚æ­¥å¤„ç†**
- âœ… æ€§èƒ½ **æå‡3-5å€**

### å‰ç«¯ä½¿ç”¨

```javascript
// å‰ç«¯ä»£ç ä¸éœ€è¦ä¿®æ”¹
fetch('http://localhost:5000/api/analyze-image', {
  method: 'POST',
  body: JSON.stringify({
    query: 'è¿™å¼ å›¾ç‰‡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ',
    image_base64: '...'
  })
})
.then(res => res.json())
.then(data => {
  // data.visual_analysis å°±æ˜¯åˆ†æç»“æœ
  console.log(data);
});
```

---

**ç°åœ¨é‡å¯APIï¼Œå‰ç«¯åº”è¯¥å°±èƒ½æ­£å¸¸å·¥ä½œäº†ï¼** ğŸŠ
