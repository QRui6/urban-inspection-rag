# ğŸš€ RAGç³»ç»Ÿéƒ¨ç½²æŒ‡å—

ä¸ºäº†è®©åŸå¸‚ä½“æ£€RAGç³»ç»Ÿèƒ½åœ¨æ²¡æœ‰Pythonç¯å¢ƒçš„ç”µè„‘ä¸Šè¿è¡Œï¼Œæˆ‘æä¾›ä»¥ä¸‹å‡ ç§éƒ¨ç½²æ–¹æ¡ˆï¼š

## ğŸ“¦ æ–¹æ¡ˆä¸€ï¼šDockerå®¹å™¨åŒ–éƒ¨ç½²ï¼ˆæ¨èï¼‰

### ä¼˜åŠ¿
- âœ… ç¯å¢ƒå®Œå…¨éš”ç¦»ï¼Œä¸ä¾èµ–å®¿ä¸»æœºPythonç¯å¢ƒ
- âœ… ä¸€é”®å¯åŠ¨ï¼Œéƒ¨ç½²ç®€å•
- âœ… è·¨å¹³å°æ”¯æŒï¼ˆWindows/Linux/macOSï¼‰
- âœ… ç‰ˆæœ¬ç®¡ç†æ–¹ä¾¿ï¼Œæ˜“äºå‡çº§

### 1.1 åˆ›å»ºDockerfile

```dockerfile
# ä½¿ç”¨Python 3.8å®˜æ–¹åŸºç¡€é•œåƒ
FROM python:3.8-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    curl \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶requirementsæ–‡ä»¶å¹¶å®‰è£…Pythonä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY . .

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p data/raw data/processed output uploads logs

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1

# æš´éœ²ç«¯å£
EXPOSE 5000

# å¯åŠ¨å‘½ä»¤
CMD ["python", "run.py", "--host", "0.0.0.0", "--port", "5000"]
```

### 1.2 åˆ›å»ºdocker-compose.yml

```yaml
version: '3.8'

services:
  rag-system:
    build: .
    ports:
      - "5000:5000"
    volumes:
      - ./data:/app/data
      - ./output:/app/output
      - ./uploads:/app/uploads
      - ./logs:/app/logs
      - ./config:/app/config
    environment:
      - ARK_API_KEY=${ARK_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
    restart: unless-stopped

  # å¯é€‰ï¼šæ·»åŠ ChromaDBç‹¬ç«‹æœåŠ¡
  chromadb:
    image: chromadb/chroma:latest
    ports:
      - "8000:8000"
    volumes:
      - ./chroma_data:/chroma/chroma
    restart: unless-stopped
```

### 1.3 åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶

```bash
# .env æ–‡ä»¶
ARK_API_KEY=your_volcengine_api_key
GEMINI_API_KEY=your_google_api_key
DASHSCOPE_API_KEY=your_qwen_api_key
```

### 1.4 éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# deploy.sh

echo "å¼€å§‹éƒ¨ç½²åŸå¸‚ä½“æ£€RAGç³»ç»Ÿ..."

# æ£€æŸ¥Dockeræ˜¯å¦å®‰è£…
if ! command -v docker &> /dev/null; then
    echo "é”™è¯¯: Dockeræœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Docker"
    exit 1
fi

# æ£€æŸ¥docker-composeæ˜¯å¦å®‰è£…
if ! command -v docker-compose &> /dev/null; then
    echo "é”™è¯¯: docker-composeæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…docker-compose"
    exit 1
fi

# æ„å»ºå’Œå¯åŠ¨æœåŠ¡
echo "æ„å»ºDockeré•œåƒ..."
docker-compose build

echo "å¯åŠ¨æœåŠ¡..."
docker-compose up -d

echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 10

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
curl -f http://localhost:5000/api/health || echo "æœåŠ¡å¯åŠ¨å¤±è´¥"

echo "éƒ¨ç½²å®Œæˆï¼"
echo "è®¿é—®åœ°å€: http://localhost:5000"
echo "APIæ–‡æ¡£: http://localhost:5000/docs"
```

## ğŸ“± æ–¹æ¡ˆäºŒï¼šPyInstallerå¯æ‰§è¡Œæ–‡ä»¶

### ä¼˜åŠ¿
- âœ… ç”Ÿæˆå•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶
- âœ… ä¸éœ€è¦å®‰è£…Pythonç¯å¢ƒ
- âœ… å¯åŠ¨é€Ÿåº¦å¿«

### 2.1 åˆ›å»ºæ‰“åŒ…è„šæœ¬

```python
# build_exe.py
import PyInstaller.__main__
import os
import shutil

def build_executable():
    """æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶"""
    
    # PyInstallerå‚æ•°
    args = [
        'run.py',                     # å…¥å£æ–‡ä»¶
        '--name=RAGåŸå¸‚ä½“æ£€ç³»ç»Ÿ',        # å¯æ‰§è¡Œæ–‡ä»¶å
        '--onefile',                   # æ‰“åŒ…æˆå•ä¸ªæ–‡ä»¶
        '--windowed',                  # Windowsä¸‹ä¸æ˜¾ç¤ºæ§åˆ¶å°
        '--icon=assets/icon.ico',      # å›¾æ ‡æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
        '--add-data=config;config',    # åŒ…å«é…ç½®æ–‡ä»¶
        '--add-data=src;src',          # åŒ…å«æºç 
        '--add-data=templates;templates',  # åŒ…å«æ¨¡æ¿æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
        '--hidden-import=uvicorn',     # éšå¼å¯¼å…¥
        '--hidden-import=fastapi',
        '--hidden-import=torch',
        '--hidden-import=transformers',
        '--hidden-import=sentence_transformers',
        '--hidden-import=chromadb',
        '--collect-all=sentence_transformers',  # æ”¶é›†æ‰€æœ‰ç›¸å…³æ–‡ä»¶
        '--collect-all=transformers',
        '--clean',                     # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    ]
    
    print("å¼€å§‹æ‰“åŒ…...")
    PyInstaller.__main__.run(args)
    
    # å¤åˆ¶å¿…è¦çš„ç›®å½•åˆ°distç›®å½•
    dist_dir = "dist"
    if os.path.exists(dist_dir):
        for folder in ['data', 'output', 'uploads', 'logs']:
            if not os.path.exists(os.path.join(dist_dir, folder)):
                os.makedirs(os.path.join(dist_dir, folder), exist_ok=True)
    
    print("æ‰“åŒ…å®Œæˆï¼å¯æ‰§è¡Œæ–‡ä»¶ä½äº dist/ ç›®å½•")

if __name__ == "__main__":
    build_executable()
```

### 2.2 åˆ›å»ºå¯åŠ¨è„šæœ¬

```batch
@echo off
REM start_rag.bat - Windowså¯åŠ¨è„šæœ¬

echo å¯åŠ¨åŸå¸‚ä½“æ£€RAGç³»ç»Ÿ...

REM æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
if not exist "RAGåŸå¸‚ä½“æ£€ç³»ç»Ÿ.exe" (
    echo é”™è¯¯: æ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶
    pause
    exit /b 1
)

REM å¯åŠ¨æœåŠ¡
echo æ­£åœ¨å¯åŠ¨æœåŠ¡...
start "RAGç³»ç»Ÿ" "RAGåŸå¸‚ä½“æ£€ç³»ç»Ÿ.exe"

REM ç­‰å¾…æœåŠ¡å¯åŠ¨
timeout /t 5 /nobreak > nul

REM æ‰“å¼€æµè§ˆå™¨
echo æ‰“å¼€æµè§ˆå™¨...
start http://localhost:5000

echo RAGç³»ç»Ÿå·²å¯åŠ¨ï¼
echo è®¿é—®åœ°å€: http://localhost:5000
echo æŒ‰ä»»æ„é”®é€€å‡º...
pause > nul
```

## â˜ï¸ æ–¹æ¡ˆä¸‰ï¼šäº‘æœåŠ¡éƒ¨ç½²

### 3.1 é˜¿é‡Œäº‘ECSéƒ¨ç½²

```bash
#!/bin/bash
# aliyun_deploy.sh

# å®‰è£…Docker
sudo yum update -y
sudo yum install -y docker
sudo systemctl start docker
sudo systemctl enable docker

# å®‰è£…docker-compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# å…‹éš†é¡¹ç›®ï¼ˆå‡è®¾å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰
cd /opt
sudo git clone <your-repo-url> rag-system
cd rag-system

# é…ç½®ç¯å¢ƒå˜é‡
sudo cp .env.example .env
sudo nano .env  # ç¼–è¾‘APIå¯†é’¥

# å¯åŠ¨æœåŠ¡
sudo docker-compose up -d

# é…ç½®é˜²ç«å¢™
sudo firewall-cmd --permanent --add-port=5000/tcp
sudo firewall-cmd --reload

echo "éƒ¨ç½²å®Œæˆï¼è®¿é—®: http://your-server-ip:5000"
```

### 3.2 è…¾è®¯äº‘è½»é‡åº”ç”¨æœåŠ¡å™¨

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  rag-system:
    build: .
    ports:
      - "80:5000"  # æ˜ å°„åˆ°80ç«¯å£
    volumes:
      - ./data:/app/data
      - ./output:/app/output
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    environment:
      - ARK_API_KEY=${ARK_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx:
    image: nginx:alpine
    ports:
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - rag-system
    restart: unless-stopped
```

## ğŸ”§ æ–¹æ¡ˆå››ï¼šæœ¬åœ°æœåŠ¡å™¨éƒ¨ç½²

### 4.1 WindowsæœåŠ¡éƒ¨ç½²

```python
# windows_service.py
import win32serviceutil
import win32service
import win32event
import servicemanager
import socket
import sys
import os
import subprocess

class RAGService(win32serviceutil.ServiceFramework):
    _svc_name_ = "RAGCityInspectionService"
    _svc_display_name_ = "åŸå¸‚ä½“æ£€RAGç³»ç»ŸæœåŠ¡"
    _svc_description_ = "åŸå¸‚ä½“æ£€RAGæ™ºèƒ½åˆ†æç³»ç»Ÿåå°æœåŠ¡"

    def __init__(self, args):
        win32serviceutil.ServiceFramework.__init__(self, args)
        self.hWaitStop = win32event.CreateEvent(None, 0, 0, None)
        self.process = None

    def SvcStop(self):
        self.ReportServiceStatus(win32service.SERVICE_STOP_PENDING)
        if self.process:
            self.process.terminate()
        win32event.SetEvent(self.hWaitStop)

    def SvcDoRun(self):
        servicemanager.LogMsg(servicemanager.EVENTLOG_INFORMATION_TYPE,
                              servicemanager.PYS_SERVICE_STARTED,
                              (self._svc_name_, ''))
        self.main()

    def main(self):
        # å¯åŠ¨RAGç³»ç»Ÿ
        script_dir = os.path.dirname(os.path.abspath(__file__))
        python_exe = sys.executable
        run_script = os.path.join(script_dir, 'run.py')
        
        self.process = subprocess.Popen([
            python_exe, run_script, 
            '--host', '0.0.0.0', 
            '--port', '5000'
        ])
        
        # ç­‰å¾…åœæ­¢ä¿¡å·
        win32event.WaitForSingleObject(self.hWaitStop, win32event.INFINITE)

if __name__ == '__main__':
    if len(sys.argv) == 1:
        servicemanager.Initialize()
        servicemanager.PrepareToHostSingle(RAGService)
        servicemanager.StartServiceCtrlDispatcher()
    else:
        win32serviceutil.HandleCommandLine(RAGService)
```

### 4.2 Linuxç³»ç»ŸæœåŠ¡

```ini
# /etc/systemd/system/rag-system.service
[Unit]
Description=åŸå¸‚ä½“æ£€RAGç³»ç»Ÿ
After=network.target

[Service]
Type=simple
User=rag
Group=rag
WorkingDirectory=/opt/rag-system
Environment=PATH=/opt/rag-system/venv/bin
ExecStart=/opt/rag-system/venv/bin/python run.py --host 0.0.0.0 --port 5000
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰å‡†å¤‡
- [ ] ç¡®è®¤APIå¯†é’¥é…ç½®æ­£ç¡®
- [ ] å‡†å¤‡çŸ¥è¯†åº“æ•°æ®æ–‡ä»¶
- [ ] æ£€æŸ¥ç³»ç»Ÿèµ„æºï¼ˆå†…å­˜â‰¥8GBï¼Œå­˜å‚¨â‰¥20GBï¼‰
- [ ] ç¡®è®¤ç½‘ç»œè¿æ¥ç¨³å®š

### Dockeréƒ¨ç½²æ£€æŸ¥
- [ ] Dockerå’Œdocker-composeå·²å®‰è£…
- [ ] ç«¯å£5000æœªè¢«å ç”¨
- [ ] .envæ–‡ä»¶é…ç½®å®Œæ•´
- [ ] æ•°æ®ç›®å½•æƒé™æ­£ç¡®

### å¯æ‰§è¡Œæ–‡ä»¶éƒ¨ç½²æ£€æŸ¥
- [ ] PyInstalleræ‰“åŒ…æˆåŠŸ
- [ ] æ‰€æœ‰ä¾èµ–æ–‡ä»¶åŒ…å«å®Œæ•´
- [ ] å¯åŠ¨è„šæœ¬æƒé™æ­£ç¡®
- [ ] é˜²ç«å¢™å’Œæ€æ¯’è½¯ä»¶ç™½åå•è®¾ç½®

### äº‘æœåŠ¡éƒ¨ç½²æ£€æŸ¥
- [ ] æœåŠ¡å™¨é…ç½®æ»¡è¶³è¦æ±‚
- [ ] å®‰å…¨ç»„/é˜²ç«å¢™è§„åˆ™é…ç½®
- [ ] åŸŸåè§£æè®¾ç½®ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] SSLè¯ä¹¦é…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰

## ğŸš¨ å¸¸è§é—®é¢˜è§£å†³

### 1. å†…å­˜ä¸è¶³
```bash
# å¢åŠ è™šæ‹Ÿå†…å­˜
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### 2. ç«¯å£è¢«å ç”¨
```bash
# æŸ¥æ‰¾å ç”¨è¿›ç¨‹
netstat -tlnp | grep :5000
# æˆ–
lsof -i :5000

# æ€æ­»è¿›ç¨‹
sudo kill -9 <PID>
```

### 3. APIè°ƒç”¨å¤±è´¥
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- éªŒè¯APIå¯†é’¥æœ‰æ•ˆæ€§
- ç¡®è®¤APIæœåŠ¡çŠ¶æ€
- æ£€æŸ¥è¯·æ±‚é¢‘ç‡é™åˆ¶

### 4. æ¨¡å‹åŠ è½½å¤±è´¥
- æ£€æŸ¥æ¨¡å‹æ–‡ä»¶å®Œæ•´æ€§
- éªŒè¯æœ¬åœ°å­˜å‚¨ç©ºé—´
- ç¡®è®¤ç½‘ç»œä¸‹è½½æƒé™
- å¢åŠ è¶…æ—¶æ—¶é—´è®¾ç½®

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ç³»ç»Ÿé…ç½®ä¼˜åŒ–
```bash
# å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# ä¼˜åŒ–ç½‘ç»œå‚æ•°
echo "net.core.somaxconn = 1024" >> /etc/sysctl.conf
sysctl -p
```

### 2. åº”ç”¨é…ç½®ä¼˜åŒ–
```python
# config/config.py æ€§èƒ½ä¼˜åŒ–é…ç½®
PERFORMANCE_CONFIG = {
    "max_workers": 4,           # æœ€å¤§å·¥ä½œè¿›ç¨‹æ•°
    "request_timeout": 30,      # è¯·æ±‚è¶…æ—¶æ—¶é—´
    "model_cache_size": 1000,   # æ¨¡å‹ç¼“å­˜å¤§å°
    "vector_cache_ttl": 3600,   # å‘é‡ç¼“å­˜æ—¶é—´
}
```

## ğŸ¯ æ¨èéƒ¨ç½²æ–¹æ¡ˆ

æ ¹æ®ä¸åŒåœºæ™¯æ¨èï¼š

### ğŸ¢ ä¼ä¸šå†…éƒ¨éƒ¨ç½²
**æ¨èï¼šDocker + LinuxæœåŠ¡å™¨**
- ç¨³å®šæ€§å¥½ï¼Œæ˜“äºç»´æŠ¤
- æ”¯æŒæ¨ªå‘æ‰©å±•
- ç›‘æ§å’Œæ—¥å¿—å®Œå–„

### ğŸ’» ä¸ªäºº/å°å›¢é˜Ÿä½¿ç”¨
**æ¨èï¼šPyInstallerå¯æ‰§è¡Œæ–‡ä»¶**
- éƒ¨ç½²ç®€å•ï¼Œä¸€é”®å¯åŠ¨
- ä¸ä¾èµ–å¤–éƒ¨ç¯å¢ƒ
- é€‚åˆæ¼”ç¤ºå’Œæµ‹è¯•

### â˜ï¸ å¯¹å¤–æœåŠ¡æä¾›
**æ¨èï¼šäº‘æœåŠ¡ + Docker**
- é«˜å¯ç”¨æ€§å’Œæ‰©å±•æ€§
- ä¸“ä¸šè¿ç»´æ”¯æŒ
- å®‰å…¨æ€§ä¿éšœ

é€‰æ‹©æœ€é€‚åˆæ‚¨ä½¿ç”¨åœºæ™¯çš„éƒ¨ç½²æ–¹æ¡ˆï¼Œç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿç¨³å®šè¿è¡Œå¹¶æä¾›ä¼˜è´¨æœåŠ¡ï¼
