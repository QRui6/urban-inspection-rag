# 🔧 检索问题修复说明

## 🐛 问题描述

在使用异步API的 `/api/complete-answer` 接口时，系统无法检索到相关的知识库内容，导致返回"未在知识库中找到相关的法规依据"。

## 🔍 根本原因

### 问题1：数据类型不匹配

**Reranker 期望的输入**：
```python
def rerank(self, query: str, documents: List[Dict[str, Any]]):
    # 实际上期望 query 是一个 dict！
    indicator_title = query.get("indicator_classification")  # 需要dict的get方法
```

**实际传入的数据**：
```python
# 在 complete_answer 方法中
if isinstance(visual_analysis, dict):
    visual_text = json.dumps(visual_analysis, ...)  # ❌ 转换成了字符串
    
# 传给rerank
reranked_docs = self.reranker.rerank(visual_text, documents)  # ❌ 传入string而不是dict
```

### 问题2：变量未定义的bug

**旧代码**：
```python
if isinstance(visual_analysis, dict):
    visual_text = json.dumps(...)
# 如果不是dict，visual_text未定义！

# 后面使用会报错
reranked_docs = self.reranker.rerank(visual_text, documents)  # ❌ 变量可能未定义
```

## ✅ 修复方案

### 修复1：区分显示文本和检索数据

```python
# 保存原始的dict用于rerank
visual_analysis_dict = visual_analysis if isinstance(visual_analysis, dict) else {}

# 生成用于显示的文本格式
if isinstance(visual_analysis, dict):
    visual_text = json.dumps(visual_analysis, ensure_ascii=False)
    visual_text = visual_text.replace("indicator_classification", "指标分类")
    ...
else:
    visual_text = str(visual_analysis) if visual_analysis else ""

# 检索时使用文本
vl_vector = self.embedder.embed_text(visual_text)
documents = self.chroma_store.search(visual_text, vl_vector)

# 重排序时使用原始dict
reranked_docs = self.reranker.rerank(visual_analysis_dict, documents)  # ✅ 传入dict
```

### 修复2：确保变量总是被定义

```python
# 无论visual_analysis是什么类型，都确保visual_text和visual_analysis_dict被定义
visual_analysis_dict = visual_analysis if isinstance(visual_analysis, dict) else {}

if isinstance(visual_analysis, dict):
    visual_text = json.dumps(...)
else:
    visual_text = str(visual_analysis) if visual_analysis else ""  # ✅ 总是有值
```

## 📊 数据流程

### 正确的流程：

```
1. API接收请求
   ↓
2. 从session_store读取visual_analysis (dict格式)
   ↓
3. 传递给complete_answer方法
   ↓
4. 分离处理：
   - visual_analysis_dict (dict) → 用于rerank
   - visual_text (string) → 用于显示和向量检索
   ↓
5. 向量检索：
   embed_text(visual_text) → 获取文档
   ↓
6. 重排序：
   rerank(visual_analysis_dict, documents) → 使用dict的indicator_classification
   ↓
7. 生成答案
```

## 🔄 修改的文件

### 1. main.py - complete_answer 方法

**修改位置**：第368-425行

**关键修改**：
- 添加 `visual_analysis_dict` 变量保存原始dict
- 确保 `visual_text` 总是被定义
- `rerank` 方法使用 `visual_analysis_dict` 而不是 `visual_text`

### 2. src/tasks/image_tasks.py - complete_answer_task

**修改位置**：第110-118行

**关键修改**：
- 错误时返回有意义的错误信息而不是 `None`
- 添加 `traceback.print_exc()` 便于调试

## 🧪 验证方法

### 1. 重启服务

```bash
# 停止所有服务
pkill -f start_worker
pkill -f api_async

# 重新启动Worker
nohup python start_worker.py > logs/worker.log 2>&1 &

# 重新启动API
python api_async.py
```

### 2. 测试接口

```bash
# 第1步：分析图片
curl -X POST http://localhost:5000/api/analyze-image \
  -H "Content-Type: application/json" \
  -d '{
    "query": "这张图片有什么问题？",
    "image_url": "test.jpg"
  }'

# 记录返回的session_id

# 第2步：生成答案
curl -X POST http://localhost:5000/api/complete-answer \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "上一步返回的session_id"
  }'
```

### 3. 查看日志

```bash
# 查看Worker日志
tail -f logs/worker.log

# 应该看到：
# - visual_analysis_dict: {...}  # dict格式
# - documents数量: X  # 应该大于0
# - 找到相关知识库内容: X 条  # 应该有结果
```

## 📝 关键点总结

### 为什么之前能工作？

实际上之前也有这个bug，但可能：
1. 测试时使用的是字符串格式的 `visual_analysis`
2. 或者 `rerank` 方法的实现不同
3. 或者使用的是旧版本的代码

### 为什么现在不工作？

1. **结构化输出**：现在使用 `use_structured_output=True`，返回的是dict
2. **类型不匹配**：dict被转换成string后传给rerank，导致 `.get()` 方法失败
3. **检索失败**：rerank无法提取 `indicator_classification`，导致匹配失败

### 核心教训

1. **类型一致性**：确保数据在整个流程中保持正确的类型
2. **明确职责**：
   - `visual_text` (string) → 用于显示和向量检索
   - `visual_analysis_dict` (dict) → 用于rerank匹配
3. **防御性编程**：确保变量总是被定义，避免 `NameError`

## ✅ 修复后的效果

- ✅ Rerank能正确提取 `indicator_classification`
- ✅ 能够检索到相关的知识库内容
- ✅ 生成准确的答案
- ✅ 不会出现变量未定义错误
- ✅ 错误信息更清晰

---

**修复完成！现在重启服务即可正常使用。**
